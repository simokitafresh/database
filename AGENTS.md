
# エージェントベース開発運用規範

## 0. この文書の目的

本プロジェクト（株価データ管理基盤）を、複数のLLMエージェント（Planner / Coder / Tester / Reviewer / Migration / Docs）で **安全・一貫** して実装/保守するための運用規範。

**実装完了記録（2025年9月5日）:** 100% (全32タスク完了)。エージェントベース開発フローにより体系的実装を達成。

公式仕様は `architecture.md`（全体設計・API・DDL・運用）と `implementation-task-list.md`（受け入れ基準つき開発タスク完了記録）。本書はそれらを実行プロトコルに翻訳したもの。 



## 1. 公式ソース（Truth Sources）

エージェントが参照すべき順序と適用方針:

1. **`architecture.md`** … システム目的、エンドポイント（/healthz, /v1/symbols, /v1/prices, **新規: /v1/coverage, /v1/fetch**）、DBスキーマ（**新規: fetch_jobs テーブル、coverage_summary ビュー**）、1ホップのシンボル変更透過解決、直近N日（既定30）リフレッチ、**QueryOptimizer による 50-70% 高速化**、デプロイ要点。矛盾時はこの文書を最優先。 

2. **`implementation-task-list.md`** … **全32タスクの完了記録**、タスクID/依存関係/受け入れ基準(AC)／成果物ファイルを定義。**実装完了済みだが今後の拡張時**にPRは必ず対応タスクIDとAC充足を明記。 

3. **`README.md`** … **完全版**システムガイド、API使用例、デプロイ手順。現在の運用中システムの実用ガイド。

**実装完了により変更された仕様:**
- **削除**: `/v1/metrics` エンドポイント（メトリクス計算機能）
- **追加**: `/v1/coverage` (カバレッジ管理), `/v1/fetch` (ジョブ管理), `DELETE /v1/prices/{symbol}` 




## 2. 役割（Agents）と責務

### 2.1 Planner（計画）

入力：新機能要求・バグ報告  
出力：作業計画メモ（対象範囲・変更ファイル・影響分析・テスト戦略）  
制約：既存の実装済み機能への影響を最小化。仕様差異は Reviewer にエスカレーション。

### 2.2 Coder（実装）

入力：Plannerの計画、既存システムとの整合性考慮  
出力：最小コミット（単一関心）、対応テスト、実装ノート  
制約：
- 既存APIの後方互換性維持
- 統合テストスイートとの整合性確保
- パフォーマンス劣化の回避

### 2.3 Tester（テスト作成）

役割：新機能・変更機能の **ACを満たす最小テスト** を作成  
ポリシー：pytest、既存テストスイートとの統合、数値は pytest.approx 許容

### 2.4 Reviewer（レビュー）

変更が既存の16API・4DB・統合テストスイート・QueryOptimizer・ジョブ管理に悪影響を与えないか確認し、後方互換性・パフォーマンス・セキュリティの観点で審査してください。

### 2.5 Migration（マイグレーション）

新機能追加時のマイグレーションスクリプト生成・テスト

### 2.6 Docs（ドキュメント）

新機能・変更の文書化、既存文書の整合性維持 



## 3. 作業プロトコル

### 3.1 ブランチ／コミット

- 実装時: `feat/TID-xxx` 形式で全32タスクを体系的に管理
- 今後: `feat/enhancement-description` / `fix/bug-description` 
- 原則: 1PR=1タスク、既存機能への影響最小化

### 3.2 PRチェックリスト

- [ ] 既存機能への影響なし（後方互換性）
- [ ] 統合テストスイートとの整合性
- [ ] パフォーマンス劣化なし
- [ ] 文書更新（README.md, architecture.md）
- [ ] セキュリティ・エラーハンドリングの妥当性 





## 4. ディレクトリ規約

```
app/
├── api/v1/              # APIエンドポイント
├── core/                # システム基盤
├── db/                  # データベース層
├── services/            # ビジネスロジック
├── migrations/          # DBマイグレーション
└── schemas/             # Pydanticスキーマ

tests/
├── integration/         # 統合テスト
└── conftest.py          # テスト設定
```

### 拡張指針
- 新機能は適切なレイヤに配置
- 既存の命名規則・構造パターンに準拠
- テストファイルは機能ごとに分離 



## 5. エージェント用標準プロンプト

### 5.1 Planner

System: 現在のシステムは100%完成済み。architecture.md と README.md を参考に、後方互換性を維持した実装計画を作成。

### 5.2 Coder

System: 既存機能を破壊せず最小差分で実装。統合テストスイートと整合するテストを追加。QueryOptimizer・ジョブ管理・カバレッジ機能との連携を考慮。

### 5.3 Tester

System: 既存の統合テストスイートがあります。新機能・変更機能のテストを作成し、既存テストとの整合性を確保。外部I/Oモック、エラーハンドリング、パフォーマンステストを含めてください。

### 5.4 Reviewer

System: 変更が既存の16API・4DB・統合テストスイート・QueryOptimizer・ジョブ管理に悪影響を与えないか確認。

### 5.5 Migration

System: 新機能に必要なDB変更のAlembicスクリプトを生成。既存データ・インデックス・ビューへの影響を分析。

### 5.6 Docs

System: 新機能・変更をREADME.md・architecture.mdに反映。既存の文書構造・品質レベルを維持。




## 6. 作業ステップ

1. **既存システム分析**: 現在のAPI・DB・テストへの影響評価
2. **設計**: 後方互換性を保った拡張設計
3. **テスト**: 既存統合テストスイートとの整合性確保
4. **実装**: パフォーマンス劣化回避・エラーハンドリング強化
5. **レビュー**: 品質・セキュリティ・運用性の総合確認
6. **文書更新**: README.md・architecture.md の整合性維持




## 7. 品質ゲート

**後方互換性**: 既存API・DB・設定ファイルへの影響なし  
**パフォーマンス**: QueryOptimizer効果の維持、レスポンス時間劣化なし  
**セキュリティ**: CORS・認証・入力バリデーションの適切な実装  
**運用性**: ログ・監視・エラー通知の品質維持  
**テスト**: 統合テストスイートとの整合性、カバレッジ維持 



## 8. よくある落とし穴と対策

**既存機能への影響**: API・DB・設定変更時の後方互換性確認必須  
**テスト整合性**: 統合テストスイートとの整合性維持  
**パフォーマンス劣化**: 新機能追加時のクエリ最適化・リソース使用量監視  
**データ整合性**: 既存データへの影響評価・マイグレーション検証 



## 9. 変更が仕様に影響する場合の手順

1. **影響分析**: Reviewerが既存のAPI・DB・テストへの影響度を評価
2. **設計**: Plannerが後方互換性を保った変更案を作成
3. **文書化**: DocsがREADME.md・architecture.mdを更新
4. **テスト**: 既存統合テストスイートとの整合性確保
5. **段階的リリース**: 既存機能を停止せず、段階的な機能追加・切り替え 




## 10. クイックリファレンス

### 現在稼働中の機能
**API**: 16エンドポイント - `/healthz`, `/v1/symbols`, `/v1/prices`, `/v1/coverage`, `/v1/fetch`  
**データベース**: 4テーブル - symbols, prices, symbol_changes, fetch_jobs + coverage_summaryビュー  
**コア機能**: 1ホップ解決 + N=30日リフレッチ + QueryOptimizer (50-70%高速化)  
**運用**: Docker + Render + 自動マイグレーション + 統合テストスイート  
**削除済み**: ~~メトリクス機能~~ (`/v1/metrics`, CAGR/STDEV/MaxDD)

### 技術スタック
**バックエンド**: FastAPI 0.104+ / SQLAlchemy 2.0+ / AsyncPG / Alembic  
**データ**: yfinance / pandas / PostgreSQL  
**品質**: pytest + pytest-asyncio / httpx / ruff + black  
**インフラ**: Docker / Render / Supabase

### テスト原則
**統合テスト**: TestBasicAPI, TestFetchJobAPI, TestCSVExportAPI  
**モック**: 外部I/O完全モック、DBはコードのみ  
**実行**: CI で pytest、パフォーマンステスト含む 



---

## 最後に

本AGENTS.mdは、実装完了済みシステムの運用プロトコルとして確立されており、今後の拡張・保守時の指針として機能します。

必ず以下を併読してください:
- **`README.md`**: 完全版システムガイド・実用的API使用例
- **`architecture.md`**: 最新システム設計・技術詳細
- **`implementation-task-list.md`**: 全32タスク完了記録・実装証跡

