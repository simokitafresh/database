# æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ç®¡ç†åŸºç›¤ - ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ

## ğŸ“… ä½œæˆæ—¥: 2025å¹´9æœˆ6æ—¥
## ğŸ¯ ç›®çš„: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã¨è‡ªå‹•ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½å®Ÿè£…
## ğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒª: https://github.com/simokitafresh/database
## ğŸŒ æœ¬ç•ªç’°å¢ƒ: https://stockdata-api-6xok.onrender.com

---

## ã‚¿ã‚¹ã‚¯é€²æ—ç®¡ç†

| ã‚¿ã‚¹ã‚¯ID | ã‚«ãƒ†ã‚´ãƒª | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Œäº†æ—¥æ™‚ |
|----------|----------|------------|----------|
| DEL-001 | å‰Šé™¤ | [ ] æœªç€æ‰‹ | - |
| DEL-002 | å‰Šé™¤ | [ ] æœªç€æ‰‹ | - |
| DEL-003 | å‰Šé™¤ | [ ] æœªç€æ‰‹ | - |
| DEL-004 | å‰Šé™¤ | [ ] æœªç€æ‰‹ | - |
| ENG-001 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| ENG-002 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| QRY-001 | æ–°æ©Ÿèƒ½ | [ ] æœªç€æ‰‹ | - |
| QRY-002 | æ–°æ©Ÿèƒ½ | [ ] æœªç€æ‰‹ | - |
| QRY-003 | æ–°æ©Ÿèƒ½ | [ ] æœªç€æ‰‹ | - |
| QRY-004 | æ–°æ©Ÿèƒ½ | [ ] æœªç€æ‰‹ | - |
| API-001 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| API-002 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| CFG-001 | è¨­å®š | [ ] æœªç€æ‰‹ | - |
| CFG-002 | è¨­å®š | [ ] æœªç€æ‰‹ | - |
| ENT-001 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| ENT-002 | ä¿®æ­£ | [ ] æœªç€æ‰‹ | - |
| RND-001 | è¨­å®š | [ ] æœªç€æ‰‹ | - |
| RND-002 | è¨­å®š | [ ] æœªç€æ‰‹ | - |
| TST-001 | ãƒ†ã‚¹ãƒˆ | [ ] æœªç€æ‰‹ | - |
| TST-002 | ãƒ†ã‚¹ãƒˆ | [ ] æœªç€æ‰‹ | - |
| TST-003 | ãƒ†ã‚¹ãƒˆ | [ ] æœªç€æ‰‹ | - |

---

## å‰Šé™¤ã‚¿ã‚¹ã‚¯

### DEL-001: queries_new.pyãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
**é–‹å§‹æ¡ä»¶**: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
rm app/db/queries_new.py
```
**å®Œäº†æ¡ä»¶**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã“ã¨
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `test ! -f app/db/queries_new.py && echo "OK"`

### DEL-002: queries_optimized.pyãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
**é–‹å§‹æ¡ä»¶**: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
rm app/db/queries_optimized.py
```
**å®Œäº†æ¡ä»¶**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã“ã¨
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `test ! -f app/db/queries_optimized.py && echo "OK"`

### DEL-003: monitoringãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
**é–‹å§‹æ¡ä»¶**: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
rm -rf app/monitoring/
```
**å®Œäº†æ¡ä»¶**: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã“ã¨
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `test ! -d app/monitoring && echo "OK"`

### DEL-004: profilingãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
**é–‹å§‹æ¡ä»¶**: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
rm -rf app/profiling/
```
**å®Œäº†æ¡ä»¶**: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã“ã¨
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `test ! -d app/profiling && echo "OK"`

---

## app/db/engine.pyä¿®æ­£ã‚¿ã‚¹ã‚¯

### ENG-001: NullPoolåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
**é–‹å§‹æ¡ä»¶**: DEL-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/engine.py`
**ä¿®æ­£å ´æ‰€**: `create_engine_and_sessionmaker`é–¢æ•°å†…ã€68è¡Œç›®ä»˜è¿‘
**ä½œæ¥­å†…å®¹**:
1. `if database_url.startswith("postgresql+asyncpg://"):`ãƒ–ãƒ­ãƒƒã‚¯å†…ã«ä»¥ä¸‹ã‚’è¿½åŠ :
```python
# æ—¢å­˜ã®connect_argsè¨­å®šã®å¾Œã«è¿½åŠ 
if "pooler.supabase.com" in database_url:
    poolclass = NullPool
    logger.info("Using NullPool for Supabase Pooler mode")
```
**å®Œäº†æ¡ä»¶**: pooler.supabase.comã‚’å«ã‚€URLã§NullPoolãŒä½¿ç”¨ã•ã‚Œã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep -n "poolclass = NullPool" app/db/engine.py`

### ENG-002: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ¼ãƒ«è¨­å®šå€¤å¤‰æ›´
**é–‹å§‹æ¡ä»¶**: ENG-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/engine.py`
**ä¿®æ­£å ´æ‰€**: é–¢æ•°å®šç¾©ã®å¼•æ•°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ45-47è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
def create_engine_and_sessionmaker(
    database_url: str,
    pool_size: int = 2,  # 5ã‹ã‚‰2ã«å¤‰æ›´
    max_overflow: int = 3,  # 5ã‹ã‚‰3ã«å¤‰æ›´
    pool_pre_ping: bool = True,
    pool_recycle: int = 900,  # 1800ã‹ã‚‰900ã«å¤‰æ›´
    echo: bool = False
) -> Tuple[AsyncEngine, async_sessionmaker[AsyncSession]]:
```
**å®Œäº†æ¡ä»¶**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "pool_size: int = 2" app/db/engine.py`

---

## app/db/queries.pyä¿®æ­£ã‚¿ã‚¹ã‚¯

### QRY-001: find_earliest_available_dateé–¢æ•°è¿½åŠ 
**é–‹å§‹æ¡ä»¶**: DEL-002å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/queries.py`
**ä¿®æ­£å ´æ‰€**: ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ï¼ˆensure_coverageé–¢æ•°ã®å¾Œï¼‰
**ä½œæ¥­å†…å®¹**:
```python
async def find_earliest_available_date(symbol: str, target_date: date) -> date:
    """
    åŠ¹ç‡çš„ã«æœ€å¤ã®åˆ©ç”¨å¯èƒ½æ—¥ã‚’æ¢ç´¢
    
    Parameters
    ----------
    symbol : str
        æ¤œç´¢å¯¾è±¡ã®ã‚·ãƒ³ãƒœãƒ«
    target_date : date
        è¦æ±‚ã•ã‚ŒãŸé–‹å§‹æ—¥
        
    Returns
    -------
    date
        å®Ÿéš›ã«åˆ©ç”¨å¯èƒ½ãªæœ€å¤æ—¥
    """
    import yfinance as yf
    from datetime import timedelta
    
    test_dates = [
        date(1970, 1, 1),
        date(1980, 1, 1),
        date(1990, 1, 1),
        date(2000, 1, 1),
        date(2010, 1, 1),
    ]
    
    for test_date in test_dates:
        if test_date >= target_date:
            try:
                df = yf.download(
                    symbol,
                    start=test_date,
                    end=test_date + timedelta(days=30),
                    progress=False,
                    timeout=5
                )
                if not df.empty:
                    return df.index[0].date()
            except:
                continue
    
    return max(target_date, date(2000, 1, 1))
```
**å®Œäº†æ¡ä»¶**: é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep -n "def find_earliest_available_date" app/db/queries.py`

### QRY-002: ensure_coverage_with_auto_fetché–¢æ•°è¿½åŠ 
**é–‹å§‹æ¡ä»¶**: QRY-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/queries.py`
**ä¿®æ­£å ´æ‰€**: find_earliest_available_dateé–¢æ•°ã®å¾Œ
**ä½œæ¥­å†…å®¹**:
```python
async def ensure_coverage_with_auto_fetch(
    session: AsyncSession,
    symbols: Sequence[str],
    date_from: date,
    date_to: date,
    refetch_days: int,
) -> Dict[str, Any]:
    """
    ãƒ‡ãƒ¼ã‚¿ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºä¿ï¼ˆæœ€å¤æ—¥è‡ªå‹•æ¤œå‡ºä»˜ãï¼‰
    
    Parameters
    ----------
    session : AsyncSession
        ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
    symbols : Sequence[str]
        å¯¾è±¡ã‚·ãƒ³ãƒœãƒ«ãƒªã‚¹ãƒˆ
    date_from : date
        è¦æ±‚é–‹å§‹æ—¥
    date_to : date
        è¦æ±‚çµ‚äº†æ—¥
    refetch_days : int
        å†å–å¾—æ—¥æ•°
        
    Returns
    -------
    Dict[str, Any]
        å–å¾—çµæœã®ãƒ¡ã‚¿æƒ…å ±
    """
    logger = logging.getLogger(__name__)
    result_meta = {
        "fetched_ranges": {},
        "row_counts": {},
        "adjustments": {}
    }
    
    for symbol in symbols:
        await with_symbol_lock(session, symbol)
        
        cov = await _get_coverage(session, symbol, date_from, date_to)
        
        if not cov.get("first_date") or cov.get("has_gaps"):
            logger.info(f"Detecting available date range for {symbol}")
            
            actual_start = await find_earliest_available_date(symbol, date_from)
            
            if actual_start > date_from:
                result_meta["adjustments"][symbol] = (
                    f"requested {date_from}, actual {actual_start}"
                )
                logger.warning(
                    f"Symbol {symbol}: Auto-adjusting date_from "
                    f"from {date_from} to {actual_start}"
                )
            
            logger.info(f"Auto-fetching {symbol} from {actual_start} to {date_to}")
            df = await fetch_prices_df(symbol=symbol, start=actual_start, end=date_to)
            
            if df is not None and not df.empty:
                rows = df_to_rows(df, symbol=symbol, source="yfinance")
                if rows:
                    up_sql = text(upsert_prices_sql())
                    await session.execute(up_sql, rows)
                    
                    result_meta["fetched_ranges"][symbol] = {
                        "from": str(actual_start),
                        "to": str(date_to)
                    }
                    result_meta["row_counts"][symbol] = len(rows)
                    
                    logger.info(
                        f"Saved {len(rows)} rows for {symbol} "
                        f"({actual_start} to {date_to})"
                    )
    
    return result_meta
```
**å®Œäº†æ¡ä»¶**: é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep -n "def ensure_coverage_with_auto_fetch" app/db/queries.py`

### QRY-003: å¿…è¦ãªimportè¿½åŠ ï¼ˆDict, Anyï¼‰
**é–‹å§‹æ¡ä»¶**: QRY-002å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/queries.py`
**ä¿®æ­£å ´æ‰€**: ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã®importéƒ¨åˆ†ï¼ˆ5è¡Œç›®ä»˜è¿‘ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
from typing import Any, List, Mapping, Optional, Sequence, cast, Dict
```
**å®Œäº†æ¡ä»¶**: Dict, AnyãŒimportã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "from typing import" app/db/queries.py | grep Dict`

### QRY-004: __all__ãƒªã‚¹ãƒˆã«é–¢æ•°è¿½åŠ 
**é–‹å§‹æ¡ä»¶**: QRY-003å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/db/queries.py`
**ä¿®æ­£å ´æ‰€**: ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ã®__all__å®šç¾©ï¼ˆ200è¡Œç›®ä»˜è¿‘ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
__all__ = [
    "ensure_coverage",
    "ensure_coverage_with_auto_fetch",  # è¿½åŠ 
    "find_earliest_available_date",  # è¿½åŠ 
    "get_prices_resolved",
    "list_symbols",
    "LIST_SYMBOLS_SQL",
]
```
**å®Œäº†æ¡ä»¶**: æ–°é–¢æ•°ãŒ__all__ã«å«ã¾ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "ensure_coverage_with_auto_fetch" app/db/queries.py | grep __all__`

---

## app/api/v1/prices.pyä¿®æ­£ã‚¿ã‚¹ã‚¯

### API-001: auto_fetchãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
**é–‹å§‹æ¡ä»¶**: QRY-004å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/v1/prices.py`
**ä¿®æ­£å ´æ‰€**: get_pricesé–¢æ•°ã®å¼•æ•°å®šç¾©ï¼ˆ46-48è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
@router.get("/prices", response_model=List[PriceRowOut])
async def get_prices(
    symbols: str = Query(..., description="Comma-separated symbols"),
    date_from: date = Query(..., alias="from"),
    date_to: date = Query(..., alias="to"),
    auto_fetch: bool = Query(True, description="Auto-fetch all available data if missing"),  # è¿½åŠ 
    session=Depends(get_session),
):
```
**å®Œäº†æ¡ä»¶**: auto_fetchãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "auto_fetch: bool" app/api/v1/prices.py`

### API-002: auto_fetchæ¡ä»¶åˆ†å²å®Ÿè£…
**é–‹å§‹æ¡ä»¶**: API-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/v1/prices.py`
**ä¿®æ­£å ´æ‰€**: ensure_coverageå‘¼ã³å‡ºã—éƒ¨åˆ†ï¼ˆ69-75è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
        t0 = time.perf_counter()
        
        if auto_fetch:
            # æ–°æ©Ÿèƒ½ï¼šæœ€å¤æ—¥ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å–å¾—
            fetch_meta = await queries.ensure_coverage_with_auto_fetch(
                session=session,
                symbols=symbols_list,
                date_from=date_from,
                date_to=date_to,
                refetch_days=settings.YF_REFETCH_DAYS,
            )
            
            if fetch_meta.get("adjustments"):
                logger.info(f"Date adjustments applied: {fetch_meta['adjustments']}")
        else:
            # å¾“æ¥ã®å‹•ä½œï¼ˆè‡ªå‹•å–å¾—ãªã—ï¼‰
            await queries.ensure_coverage(
                session=session,
                symbols=symbols_list,
                date_from=date_from,
                date_to=date_to,
                refetch_days=settings.YF_REFETCH_DAYS,
            )
```
**å®Œäº†æ¡ä»¶**: æ¡ä»¶åˆ†å²ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep -A5 "if auto_fetch:" app/api/v1/prices.py`

---

## app/core/config.pyä¿®æ­£ã‚¿ã‚¹ã‚¯

### CFG-001: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šå€¤å¤‰æ›´
**é–‹å§‹æ¡ä»¶**: API-002å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/core/config.py`
**ä¿®æ­£å ´æ‰€**: Settingsã‚¯ãƒ©ã‚¹å†…ã®å®šæ•°å®šç¾©ï¼ˆ20-30è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
    # Database connection pool settings
    DB_POOL_SIZE: int = 2  # 5ã‹ã‚‰2ã«å¤‰æ›´
    DB_MAX_OVERFLOW: int = 3  # 5ã‹ã‚‰3ã«å¤‰æ›´
    DB_POOL_PRE_PING: bool = True
    DB_POOL_RECYCLE: int = 900  # 1800ã‹ã‚‰900ã«å¤‰æ›´
    DB_ECHO: bool = False
```
**å®Œäº†æ¡ä»¶**: å€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "DB_POOL_SIZE: int = 2" app/core/config.py`

### CFG-002: Fetchã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤å¤‰æ›´
**é–‹å§‹æ¡ä»¶**: CFG-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/core/config.py`
**ä¿®æ­£å ´æ‰€**: Settingsã‚¯ãƒ©ã‚¹å†…ã®FETCHé–¢é€£è¨­å®šï¼ˆ34-40è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```python
    YF_REQ_CONCURRENCY: int = 2  # 4ã‹ã‚‰2ã«å¤‰æ›´
    FETCH_TIMEOUT_SECONDS: int = 30  # 8ã‹ã‚‰30ã«å¤‰æ›´
    FETCH_MAX_RETRIES: int = 3
    FETCH_BACKOFF_MAX_SECONDS: float = 8.0
    REQUEST_TIMEOUT_SECONDS: int = 45  # 15ã‹ã‚‰45ã«å¤‰æ›´
```
**å®Œäº†æ¡ä»¶**: å€¤ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "FETCH_TIMEOUT_SECONDS: int = 30" app/core/config.py`

---

## docker/entrypoint.shä¿®æ­£ã‚¿ã‚¹ã‚¯

### ENT-001: entrypoint.shå…¨ä½“ç½®ãæ›ãˆ
**é–‹å§‹æ¡ä»¶**: CFG-002å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `docker/entrypoint.sh`
**ä¿®æ­£å ´æ‰€**: ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“
**ä½œæ¥­å†…å®¹**: ä»¥ä¸‹ã®å†…å®¹ã§å…¨ä½“ã‚’ç½®ãæ›ãˆ
```bash
#!/usr/bin/env bash
set -euo pipefail

# ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
export ALEMBIC_DATABASE_URL="${ALEMBIC_DATABASE_URL:-${DATABASE_URL}}"

# URLãƒ‰ãƒ©ã‚¤ãƒãƒ¼å¤‰æ›ï¼ˆasyncpg â†’ psycopgï¼‰
if [[ "$ALEMBIC_DATABASE_URL" == *"asyncpg"* ]]; then
    export ALEMBIC_DATABASE_URL="${ALEMBIC_DATABASE_URL//asyncpg/psycopg}"
fi

echo "[entrypoint] Running migrations..."
alembic upgrade head || {
    echo "[entrypoint] Migration failed, attempting stamp..."
    alembic stamp head
}

echo "[entrypoint] Starting server..."
exec gunicorn app.main:app \
    --workers="${WEB_CONCURRENCY:-2}" \
    --worker-class=uvicorn.workers.UvicornWorker \
    --bind="0.0.0.0:${PORT:-8000}" \
    --timeout="${GUNICORN_TIMEOUT:-60}"
```
**å®Œäº†æ¡ä»¶**: ãƒ•ã‚¡ã‚¤ãƒ«ãŒ50è¡Œä»¥ä¸‹ã«ãªã£ã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `wc -l docker/entrypoint.sh | awk '{print ($1 < 50) ? "OK" : "NG"}'`

### ENT-002: å®Ÿè¡Œæ¨©é™ä»˜ä¸
**é–‹å§‹æ¡ä»¶**: ENT-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `docker/entrypoint.sh`
**ä½œæ¥­å†…å®¹**:
```bash
chmod +x docker/entrypoint.sh
```
**å®Œäº†æ¡ä»¶**: å®Ÿè¡Œæ¨©é™ãŒã‚ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `test -x docker/entrypoint.sh && echo "OK"`

---

## render.yamlä¿®æ­£ã‚¿ã‚¹ã‚¯

### RND-001: ã‚µãƒ¼ãƒ“ã‚¹åã¨planè¨­å®š
**é–‹å§‹æ¡ä»¶**: ENT-002å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `render.yaml`
**ä¿®æ­£å ´æ‰€**: servicesã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1-5è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```yaml
services:
  - type: web
    name: stockdata-api  # stock-apiã‹ã‚‰å¤‰æ›´
    env: docker
    plan: starter
```
**å®Œäº†æ¡ä»¶**: nameå¤‰æ›´ã¨planæ˜ç¤º
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "name: stockdata-api" render.yaml`

### RND-002: ç’°å¢ƒå¤‰æ•°å€¤æ›´æ–°
**é–‹å§‹æ¡ä»¶**: RND-001å®Œäº†
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `render.yaml`
**ä¿®æ­£å ´æ‰€**: envVarsã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ10-30è¡Œç›®ï¼‰
**ä½œæ¥­å†…å®¹**:
```yaml
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: ALEMBIC_DATABASE_URL
        sync: false
      - key: DB_POOL_SIZE
        value: "2"  # 3ã‹ã‚‰2ã«å¤‰æ›´
      - key: DB_MAX_OVERFLOW
        value: "3"  # 2ã‹ã‚‰3ã«å¤‰æ›´
      - key: DB_POOL_RECYCLE
        value: "900"  # 1800ã‹ã‚‰900ã«å¤‰æ›´
      - key: GUNICORN_TIMEOUT
        value: "60"  # 180ã‹ã‚‰60ã«å¤‰æ›´
      - key: FETCH_TIMEOUT_SECONDS
        value: "30"  # æ–°è¦è¿½åŠ 
      - key: REQUEST_TIMEOUT_SECONDS
        value: "45"  # æ–°è¦è¿½åŠ 
      - key: YF_REQ_CONCURRENCY
        value: "2"  # 4ã‹ã‚‰2ã«å¤‰æ›´
      - key: WEB_CONCURRENCY
        value: "2"
      - key: API_MAX_SYMBOLS
        value: "50"
      - key: API_MAX_ROWS
        value: "1000000"
```
**å®Œäº†æ¡ä»¶**: ç’°å¢ƒå¤‰æ•°ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `grep "FETCH_TIMEOUT_SECONDS" render.yaml`

---

## ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯

### TST-001: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
**é–‹å§‹æ¡ä»¶**: RND-002å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
docker-compose build
```
**å®Œäº†æ¡ä»¶**: ãƒ“ãƒ«ãƒ‰æˆåŠŸ
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `echo $?` (0ãªã‚‰æˆåŠŸ)

### TST-002: ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ãƒ†ã‚¹ãƒˆ
**é–‹å§‹æ¡ä»¶**: TST-001å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
docker-compose up -d
sleep 10
curl http://localhost:8000/healthz
```
**å®Œäº†æ¡ä»¶**: {"status": "ok"}ãŒè¿”ã‚‹
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `curl -s http://localhost:8000/healthz | grep '"status": "ok"'`

### TST-003: è‡ªå‹•å–å¾—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
**é–‹å§‹æ¡ä»¶**: TST-002å®Œäº†
**ä½œæ¥­å†…å®¹**:
```bash
curl "http://localhost:8000/v1/prices?symbols=AAPL&from=1990-01-01&to=2024-01-31&auto_fetch=true"
```
**å®Œäº†æ¡ä»¶**: ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã‚‹ï¼ˆç©ºé…åˆ—ã§ãªã„ï¼‰
**æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰**: `curl -s "http://localhost:8000/v1/prices?symbols=AAPL&from=2024-01-01&to=2024-01-31" | jq length`

---

## å®Ÿè£…é †åº

1. **å‰Šé™¤ãƒ•ã‚§ãƒ¼ã‚º** (5åˆ†)
   - DEL-001ã€œDEL-004: ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤ä¿®æ­£** (20åˆ†)
   - ENG-001ã€œENG-002: engine.pyä¿®æ­£
   - QRY-001ã€œQRY-004: queries.pyä¿®æ­£

3. **APIå±¤ä¿®æ­£** (10åˆ†)
   - API-001ã€œAPI-002: prices.pyä¿®æ­£

4. **è¨­å®šä¿®æ­£** (10åˆ†)
   - CFG-001ã€œCFG-002: config.pyä¿®æ­£
   - ENT-001ã€œENT-002: entrypoint.shä¿®æ­£
   - RND-001ã€œRND-002: render.yamlä¿®æ­£

5. **ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º** (15åˆ†)
   - TST-001ã€œTST-003: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

**ç·æ‰€è¦æ™‚é–“**: ç´„60åˆ†

---

## æ³¨æ„äº‹é …

1. **ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å®Ÿè£…**: ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ä½œæˆã—ãªã„
2. **å®Œå…¨ç½®ãæ›ãˆ**: ä¿®æ­£æ™‚ã¯æŒ‡å®šéƒ¨åˆ†ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã‚‹
3. **ãƒ†ã‚¹ãƒˆå¿…é ˆ**: å„ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«æ¤œè¨¼ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
4. **é †åºå³å®ˆ**: é–‹å§‹æ¡ä»¶ã‚’æº€ãŸã—ã¦ã‹ã‚‰å®Ÿè¡Œ
5. **ã‚¨ãƒ©ãƒ¼æ™‚**: å³åº§ã«åœæ­¢ã—ã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¨˜éŒ²

---

## ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```
fix: [ã‚¿ã‚¹ã‚¯ID] ã‚¿ã‚¹ã‚¯å†…å®¹

- å¤‰æ›´å†…å®¹ã®è©³ç´°
- å½±éŸ¿ç¯„å›²
- ãƒ†ã‚¹ãƒˆçµæœ
```

ä¾‹:
```
fix: [QRY-001] Add find_earliest_available_date function

- Added automatic detection of earliest available date
- Function tries common start dates to find data
- Tested with AAPL, MSFT symbols
```