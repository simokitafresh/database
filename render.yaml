# This file defines the Render deployment configuration.
# See https://render.com/docs/blueprint-spec for details.

services:
  - type: web
    name: stockdata-api
    runtime: python
    plan: starter
    autoDeploy: true
    healthCheckPath: /healthz
    buildCommand: |
      pip install --upgrade pip &&
      pip install --no-cache-dir -r requirements.txt &&
      echo "Running database migration..." &&
      alembic upgrade head &&
      echo "Migration completed!"
    startCommand: gunicorn app.main:app --bind 0.0.0.0:$PORT --workers 2 --worker-class uvicorn.workers.UvicornWorker --timeout 60
    envVars:
      # === Required Secrets (set in Render Dashboard) ===
      - key: DATABASE_URL
        sync: false  # Set manually: Direct connection with IPv4 add-on
      - key: ALEMBIC_DATABASE_URL
        sync: false  # Set manually: Same as DATABASE_URL but with psycopg driver
      - key: CRON_SECRET_TOKEN
        sync: false  # Set manually
      - key: FRED_API_KEY
        sync: false  # Set manually
      
      # === Non-default Configuration ===
      - key: APP_ENV
        value: "production"
      - key: CORS_ALLOW_ORIGINS
        value: "*"  # Restrict in production
      - key: CRON_FULL_HISTORY_TIMEOUT
        value: "600"
      
      # All other settings use defaults from app/core/config.py:
      # - DB_POOL_SIZE: 5
      # - DB_MAX_OVERFLOW: 5
      # - API_MAX_SYMBOLS: 10
      # - API_MAX_ROWS: 50000
      # - ENABLE_CACHE: true
      # - LOG_LEVEL: INFO
      # etc.

  - type: cron
    name: stockdata-daily-update
    runtime: docker
    dockerfilePath: ./docker/Dockerfile.cron
    schedule: "0 14 * * 1-5"  # 14:00 UTC (23:00 JST) on weekdays
    envVars:
      - key: RENDER_EXTERNAL_URL
        fromService:
          name: stockdata-api
          type: web
          property: host
      - key: CRON_SECRET_TOKEN
        sync: false
