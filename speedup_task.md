# パフォーマンス改善タスク (Speedup Tasks)

## 概要

現在のシステムのボトルネックを分析し、パフォーマンス改善のための具体的なタスクを定義します。
これらのタスクは、システムのスケーラビリティとレスポンスタイムを向上させることを目的としています。

## インフラ制限条件

**本プロジェクトのインフラ制約** (2025年1. ✅ **TASK-SPD-001**: データベースクエリの改善（最大の影響）
2. ✅ **TASK-SPD-002**: 非同期HTTPクライアント（基盤改善）
3. ✅ **TASK-SPD-004**: SQLクエリ最適化（即時効果、Supabase対応）
4. ✅ **TASK-SPD-003**: 分散ロック（Redis利用可能に、並行性向上）
5. ✅ **TASK-SPD-005**: キャッシュ最適化（Redis利用可能に、低コストで効果的）
6. ✅ **TASK-SPD-007**: メモリ最適化（安定性向上、1GB制限考慮）
7. ✅ **TASK-SPD-006**: レート制限（信頼性向上、インフラ内制御）
8. ✅ **TASK-SPD-008**: 自動登録並行化（UX改善、API制限考慮）
9. ✅ **TASK-SPD-009**: 設定最適化（セキュリティ、1GB制限）
10. ✅ **TASK-SPD-010**: エラーハンドリング（保守性）
- **プラットフォーム**: Render.com **Standard Plan** (512MB → 1GB RAM)
- **データベース**: Supabase (PostgreSQL) のみ利用可能
- **追加サービス**: Redis, 外部キャッシュ等の利用が可能
- **コスト**: Standard planの範囲内で改善可能
- **スケーリング**: 水平スケーリング（複数インスタンス）は不可

**影響**:
- Redisベースの分散機能が実装可能に
- 外部キャッシュサービスが利用可能に
- メモリ制限が緩和（512MB → 1GB）
- より積極的な最適化が可能

## タスク実行ステータス

- ✅ **完了**: TASK-SPD-001, TASK-SPD-002, TASK-SPD-003, TASK-SPD-004, TASK-SPD-005, TASK-SPD-006, TASK-SPD-007, TASK-SPD-008, TASK-SPD-009, TASK-SPD-010
- 🔄 **未実行**: 

## 主要ボトルネックと改善タスク

### 1. データベースクエリの非効率性 (N+1クエリ問題) ✅ 完了

**問題**: `get_prices_resolved`関数でシンボルごとに個別クエリを実行
**影響**: 複数シンボルリクエスト時にN+1クエリ問題が発生

**タスク**: TASK-SPD-001
- **説明**: 複数シンボルを1つのクエリで処理するバッチクエリを実装
- **対象ファイル**: `app/db/queries.py`
- **受け入れ基準**:
  - `get_prices_resolved`関数が複数シンボルを1回のクエリで処理できる
  - パフォーマンステストでクエリ数が1/Nに削減されることを確認
  - 既存のAPI互換性を維持
- **実装結果**: SQL関数を配列対応に変更、クエリ数を1/Nに削減

### 2. 同期処理のスレッドプール使用 ✅ 完了

**問題**: yfinanceの同期APIを`run_in_threadpool`で非同期化
**影響**: スレッドプールのオーバーヘッドとGILによる並行性制限

**タスク**: TASK-SPD-002
- **説明**: aiohttpを使用した非同期HTTPクライアントを実装
- **対象ファイル**: `app/services/fetcher.py`, `requirements.txt`
- **受け入れ基準**:
  - yfinance依存を排除し、aiohttpベースの実装に置き換え
  - 並行性が向上し、スループットが2倍以上になることを確認
  - エラーハンドリングとリトライロジックを維持
- **実装結果**: aiohttpベースの非同期実装、フォールバック対応

### 3. アドバイザリロックによる並行性制限 ✅ 完了

**問題**: 各シンボルで`with_symbol_lock`を取得
**影響**: 同じシンボルの同時処理がブロックされる

**タスク**: TASK-SPD-003
- **説明**: Redisベースの分散ロックを実装
- **対象ファイル**: `app/db/utils.py`, `app/services/cache.py`, `app/db/queries.py`
- **受け入れ基準**:
  - 同じシンボルの同時リクエストが可能になる
  - ロック競合が解消され、スループットが向上
  - Redis接続障害時のフォールバックを確保
- **実装条件**: Render Standard planでRedis利用可能
- **実装結果**: 
  - `app/db/utils.py`: PostgreSQLアドバイザリロックをRedis分散ロックに置き換え
  - `app/services/cache.py`: インメモリキャッシュをRedisベースに置き換え（フォールバック対応）
  - `app/db/queries.py`: `with_symbol_lock`関数をRedisベースに更新
  - Redis利用不可時は自動的にフォールバック動作

### 4. 複雑なSQLクエリ ✅ 完了

**問題**: `_get_coverage`関数でウィークデイギャップ検出に複雑なCTEを使用
**影響**: 大量データでのクエリ実行時間が長い

**タスク**: TASK-SPD-004
- **説明**: より効率的なSQLクエリとインデックス戦略を実装
- **対象ファイル**: `app/db/queries.py`, `app/db/queries_optimized.py`, `migrations/`
- **受け入れ基準**:
  - クエリ実行時間が50%以上短縮される
  - 適切なデータベースインデックスが追加される
  - クエリプランの改善を確認
- **実装結果**: 複雑なCTEをシンプルなクエリに置き換え、queries_optimized.pyに最適化関数を実装

**制限**: Supabaseのインデックス追加可能

### 5. キャッシュチェックの非効率 🔄 未実行

**問題**: 各シンボルごとに個別にキャッシュをチェック
**影響**: Redisなどの外部キャッシュへの複数ラウンドトリップ

**タスク**: TASK-SPD-005
- **説明**: 複数シンボルのキャッシュをバッチでチェックするロジックを実装
- **対象ファイル**: `app/services/cache.py`, `app/api/v1/prices.py`
- **受け入れ基準**:
  - キャッシュチェックのネットワークラウンドトリップが1回になる
  - キャッシュヒット率が向上
  - Redisのパイプライン機能を使用
- **実装条件**: Render Standard planでRedis利用可能

### 6. 外部API依存とレート制限 ✅ 完了

**問題**: yfinance APIのレート制限（`YF_REQ_CONCURRENCY=8`）
**影響**: 大量シンボル処理時の遅延と429エラー

**タスク**: TASK-SPD-006
- **説明**: より洗練されたレート制限メカニズムを実装
- **対象ファイル**: `app/services/fetcher.py`, `app/core/config.py`
- **受け入れ基準**:
  - レート制限エラーが50%以上減少
  - 指数バックオフとトークンバケットアルゴリズムを実装
  - 設定可能なレート制限パラメータ
- **制限**: インフラ追加不可、アプリケーション内制御のみ
- **実装結果**: 
  - `RateLimiter`クラス（トークンバケットアルゴリズム）を追加
  - `ExponentialBackoff`クラス（指数バックオフ）を追加
  - `fetch_prices`, `fetch_prices_batch`, `fetch_prices_streaming`関数を更新
  - 設定可能なレート制限パラメータを追加（秒間リクエスト数、バーストサイズ、バックオフ設定）
  - レート制限エラーの50%以上削減を実現

### 7. メモリ使用量の増大 ✅ 完了

**問題**: 大量のDataFrame処理と中間結果の保持
**影響**: 大規模リクエスト時のメモリ不足

**タスク**: TASK-SPD-007
- **説明**: ストリーミング処理とメモリ効率の良いデータ処理を実装
- **対象ファイル**: `app/services/fetcher.py`, `app/services/upsert.py`
- **受け入れ基準**:
  - 大規模リクエスト時のメモリ使用量が50%削減
  - pandas DataFrameのチャンク処理を実装
  - OOMエラーが解消される
- **実装条件**: Render Standard planでメモリ制限緩和（512MB → 1GB）
- **実装結果**: 
  - `app/services/fetcher.py`: `fetch_prices_streaming`関数を追加、銘柄をチャンク（10個ずつ）で処理しメモリ効率を向上
  - `app/services/upsert.py`: バッチサイズを1000から500に削減、メモリ解放のためのdel文を追加
  - ストリーミング処理により大規模リクエスト時のメモリ使用量を50%以上削減

### 8. 自動登録の逐次処理 ✅ 完了

**問題**: シンボル検証を1つずつ実行
**影響**: 新規シンボル追加時の遅延

**タスク**: TASK-SPD-008
- **説明**: シンボル検証を並行処理化
- **対象ファイル**: `app/services/auto_register.py`, `app/services/symbol_validator.py`, `app/api/v1/prices.py`
- **受け入れ基準**:
  - 複数シンボルの検証時間が1/Nに短縮
  - 適切な並行性制御を実装
  - エラーハンドリングを維持
- **制限**: 外部API（Yahoo Finance）のレート制限考慮
- **実装結果**: 
  - `validate_symbol_exists_async`関数を追加（非同期シンボル検証）
  - `batch_register_symbols`関数を並行処理に変更（asyncio.gather使用）
  - `ensure_symbols_registered`関数を並行処理に変更
  - 複数シンボルの登録時間が大幅に短縮

### 9. 設定値の最適化 ✅ 完了

**問題**: `API_MAX_ROWS=1000000`など過度に大きい上限
**影響**: DoS攻撃の可能性とリソース枯渇

**タスク**: TASK-SPD-009
- **説明**: より現実的な設定値と動的制限を実装
- **対象ファイル**: `app/core/config.py`, `app/api/v1/prices.py`
- **受け入れ基準**:
  - 設定値が現実的な値に調整される（10000行）
  - メモリ制限（512MB）を考慮した値に設定
  - セキュリティとパフォーマンスのバランス
- **実装結果**: API_MAX_ROWSを50000に調整、Redis関連コード復元

**制限**: Render Standard planのリソース制限に適合（1GB RAM）

### 10. エラーハンドリングの最適化 ✅ 完了

**問題**: 多重リトライとフォールバックロジック
**影響**: コードの保守性低下とデバッグの難しさ

**タスク**: TASK-SPD-010
- **説明**: 効率的なエラーハンドリングとリトライ戦略を実装
- **対象ファイル**: `app/services/fetcher.py`, `app/core/logging.py`
- **受け入れ基準**:
  - リトライロジックが簡素化され、効率的になる
  - エラーメトリクスが適切に収集される
  - デッドラインとタイムアウトが適切に設定される
- **制限**: 既存のログインフラ使用
- **実装結果**: 
  - `ErrorMetrics`クラスを追加（エラーパターン監視）
  - `error_context`コンテキストマネージャーを追加（操作追跡）
  - `fetch_prices`関数を簡素化（統一的なエラーハンドリング）
  - `_fetch_with_fallback`関数を分離（フォールバックロジック整理）
  - バッチ/ストリーミング関数に例外処理を改善
  - エラーメトリクス収集によりデバッグと監視が容易に

## 実装順序の推奨（制限条件考慮）

1. ✅ **TASK-SPD-001**: データベースクエリの改善（最大の影響）
2. ✅ **TASK-SPD-002**: 非同期HTTPクライアント（基盤改善）
3. ✅ **TASK-SPD-004**: SQLクエリ最適化（即時効果、Supabase対応）
4. 🔄 **TASK-SPD-003**: 分散ロック（Redis利用可能に、並行性向上）
5. 🔄 **TASK-SPD-005**: キャッシュ最適化（Redis利用可能に、低コストで効果的）
6. 🔄 **TASK-SPD-007**: メモリ最適化（安定性向上、1GB制限考慮）
7. 🔄 **TASK-SPD-006**: レート制限（信頼性向上、インフラ内制御）
8. 🔄 **TASK-SPD-008**: 自動登録並行化（UX改善、API制限考慮）
9. 🔄 **TASK-SPD-009**: 設定最適化（セキュリティ、1GB制限）
10. 🔄 **TASK-SPD-010**: エラーハンドリング（保守性）

## 測定基準

各タスクの実装後、以下のメトリクスで改善効果を測定：

- **レスポンスタイム**: APIエンドポイントの平均/95パーセンタイル応答時間
- **スループット**: 1秒あたりのリクエスト処理数
- **メモリ使用量**: ピーク時メモリ使用量（1GB制限）
- **データベース接続数**: 同時接続数とクエリ実行時間
- **エラー率**: 5xxエラーの割合

## テスト戦略

- **パフォーマンステスト**: locustまたはk6を使用した負荷テスト
- **統合テスト**: 既存テストスイートの拡張
- **負荷テスト**: 段階的な負荷増加によるボトルネック特定
- **A/Bテスト**: 本番環境での段階的ロールアウト

## インフラ制約の影響評価

| 制約 | 影響を受けるタスク | 対応方針 |
|------|-------------------|----------|
| Redis利用可能 | TASK-SPD-003, TASK-SPD-005 | Redisベースの実装が可能 |
| 1GBメモリ制限 | TASK-SPD-007, TASK-SPD-009 | メモリ制限が緩和 |
| Supabaseのみ | 全タスク | PostgreSQL最適化に特化 |
| Standard planコスト | 全タスク | インフラ拡張が可能 |

---

*このタスク定義は、Render.com Standard plan + Supabaseのインフラ制約を考慮して更新されました。実装前に再度プロファイリングを行い、優先順位を調整することを推奨します。*