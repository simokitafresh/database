============================= test session starts =============================
platform win32 -- Python 3.12.0, pytest-8.2.0, pluggy-1.6.0 -- C:\Users\simok\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Python_app\database
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-0.23.6, cov-4.1.0, mock-3.12.0, timeout-2.4.0
asyncio: mode=Mode.AUTO
timeout: 30.0s
timeout method: thread
timeout func_only: False
collecting ... collected 3 items

tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_triggers_autofix_on_split FAILED [ 33%]
tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_no_autofix_when_disabled FAILED [ 66%]
tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_no_autofix_for_dividend FAILED [100%]

================================== FAILURES ===================================
______________ test_fetch_symbol_data_triggers_autofix_on_split _______________

    @pytest.mark.asyncio
    async def test_fetch_symbol_data_triggers_autofix_on_split():
        """Test that split events trigger auto-fix functionality."""
    
        with patch("app.services.fetch_worker.settings") as mock_settings:
            mock_settings.DATABASE_URL = "sqlite+aiosqlite:///:memory:"
            mock_settings.DB_POOL_PRE_PING = False
            mock_settings.DB_POOL_RECYCLE = 3600
            mock_settings.ADJUSTMENT_AUTO_FIX = True  # Enable auto-fix
    
            # Mock data with split event
            mock_df = pd.DataFrame({
                "open": [100.0], "high": [110.0], "low": [90.0], "close": [105.0], "volume": [1000]
            }, index=pd.to_datetime(["2020-01-01"]))
    
            mock_events = [
                {
                    "date": date(2020, 1, 1),
                    "type": "stock_split",
                    "ratio": 2.0,
                    "symbol": "AAPL"
                }
            ]
    
            # Mock run_in_threadpool
            async def mock_run_in_threadpool(func, *args, **kwargs):
                return mock_df, mock_events
    
            with patch("app.services.fetch_worker.run_in_threadpool", side_effect=mock_run_in_threadpool):
    
                # Mock sessions
                mock_session = AsyncMock()
                mock_session_cls = MagicMock(return_value=mock_session)
                mock_session.__aenter__.return_value = mock_session
    
                # Mock AdjustmentFixer
>               with patch("app.services.fetch_worker.AdjustmentFixer") as MockFixer:

tests\unit\test_fetch_worker_autofix.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1455: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x00000248BD27CDD0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'app.services.fetch_worker' from 'C:\\Python_app\\database\\app\\services\\fetch_worker.py'> does not have the attribute 'AdjustmentFixer'

C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1428: AttributeError
_______________ test_fetch_symbol_data_no_autofix_when_disabled _______________

    @pytest.mark.asyncio
    async def test_fetch_symbol_data_no_autofix_when_disabled():
        """Test that auto-fix is skipped when ADJUSTMENT_AUTO_FIX=False."""
    
        with patch("app.services.fetch_worker.settings") as mock_settings:
            mock_settings.DATABASE_URL = "sqlite+aiosqlite:///:memory:"
            mock_settings.DB_POOL_PRE_PING = False
            mock_settings.DB_POOL_RECYCLE = 3600
            mock_settings.ADJUSTMENT_AUTO_FIX = False  # Disable auto-fix
    
            mock_df = pd.DataFrame({
                "open": [100.0], "high": [110.0], "low": [90.0], "close": [105.0], "volume": [1000]
            }, index=pd.to_datetime(["2020-01-01"]))
    
            mock_events = [
                {
                    "date": date(2020, 1, 1),
                    "type": "stock_split",
                    "ratio": 2.0,
                    "symbol": "AAPL"
                }
            ]
    
            async def mock_run_in_threadpool(func, *args, **kwargs):
                return mock_df, mock_events
    
            with patch("app.services.fetch_worker.run_in_threadpool", side_effect=mock_run_in_threadpool):
                mock_session = AsyncMock()
                mock_session_cls = MagicMock(return_value=mock_session)
                mock_session.__aenter__.return_value = mock_session
    
>               with patch("app.services.fetch_worker.AdjustmentFixer") as MockFixer:

tests\unit\test_fetch_worker_autofix.py:121: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1455: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x00000248BD3BD250>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'app.services.fetch_worker' from 'C:\\Python_app\\database\\app\\services\\fetch_worker.py'> does not have the attribute 'AdjustmentFixer'

C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1428: AttributeError
_______________ test_fetch_symbol_data_no_autofix_for_dividend ________________

    @pytest.mark.asyncio
    async def test_fetch_symbol_data_no_autofix_for_dividend():
        """Test that dividends don't trigger auto-fix."""
    
        with patch("app.services.fetch_worker.settings") as mock_settings:
            mock_settings.DATABASE_URL = "sqlite+aiosqlite:///:memory:"
            mock_settings.DB_POOL_PRE_PING = False
            mock_settings.DB_POOL_RECYCLE = 3600
            mock_settings.ADJUSTMENT_AUTO_FIX = True
    
            mock_df = pd.DataFrame({
                "open": [100.0], "high": [110.0], "low": [90.0], "close": [105.0], "volume": [1000]
            }, index=pd.to_datetime(["2020-01-01"]))
    
            # Only dividend event, no split
            mock_events = [
                {
                    "date": date(2020, 1, 1),
                    "type": "dividend",
                    "amount": 0.25,
                    "symbol": "AAPL"
                }
            ]
    
            async def mock_run_in_threadpool(func, *args, **kwargs):
                return mock_df, mock_events
    
            with patch("app.services.fetch_worker.run_in_threadpool", side_effect=mock_run_in_threadpool):
                mock_session = AsyncMock()
                mock_session_cls = MagicMock(return_value=mock_session)
                mock_session.__aenter__.return_value = mock_session
    
>               with patch("app.services.fetch_worker.AdjustmentFixer") as MockFixer:

tests\unit\test_fetch_worker_autofix.py:169: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1455: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x00000248BD4320F0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'app.services.fetch_worker' from 'C:\\Python_app\\database\\app\\services\\fetch_worker.py'> does not have the attribute 'AdjustmentFixer'

C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1428: AttributeError
============================== warnings summary ===============================
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

app\schemas\fetch_jobs.py:17
  C:\Python_app\database\app\schemas\fetch_jobs.py:17: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('symbols')

app\schemas\fetch_jobs.py:34
  C:\Python_app\database\app\schemas\fetch_jobs.py:34: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_to')

app\schemas\fetch_jobs.py:53
  C:\Python_app\database\app\schemas\fetch_jobs.py:53: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_from')

app\schemas\fetch_jobs.py:64
  C:\Python_app\database\app\schemas\fetch_jobs.py:64: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('interval')

app\schemas\fetch_jobs.py:71
  C:\Python_app\database\app\schemas\fetch_jobs.py:71: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('priority')

app\schemas\fetch_jobs.py:88
  C:\Python_app\database\app\schemas\fetch_jobs.py:88: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('percent')

app\schemas\cron.py:28
  C:\Python_app\database\app\schemas\cron.py:28: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator("date_from", "date_to", pre=True)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_triggers_autofix_on_split
FAILED tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_no_autofix_when_disabled
FAILED tests/unit/test_fetch_worker_autofix.py::test_fetch_symbol_data_no_autofix_for_dividend
======================= 3 failed, 12 warnings in 0.33s ========================
