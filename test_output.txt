============================= test session starts =============================
platform win32 -- Python 3.12.0, pytest-8.2.0, pluggy-1.6.0
rootdir: C:\Python_app\database
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-0.23.6, cov-4.1.0, mock-3.12.0, timeout-2.4.0
asyncio: mode=Mode.AUTO
timeout: 30.0s
timeout method: thread
timeout func_only: False
collected 1 item

tests/test_cron_adjustment.py::TestAdjustmentCheckEndpoint::test_adjustment_check_auth_required 
-------------------------------- live log call --------------------------------
WARNING  app.api.v1.cron:cron.py:22 CRON_SECRET_TOKEN not set, skipping authentication
ERROR    app.services.daily_update_service:daily_update_service.py:247 Unexpected error in adjustment_check
Traceback (most recent call last):
  File "C:\Python_app\database\app\services\daily_update_service.py", line 213, in check_adjustments
    scan_result = await detector.scan_all_symbols(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python_app\database\app\services\adjustment_detector.py", line 504, in scan_all_symbols
    symbols = [row[0] for row in result.fetchall()]
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
INFO     httpx:_client.py:1773 HTTP Request: POST http://test/v1/adjustment-check "HTTP/1.1 500 Internal Server Error"
FAILED                                                                   [100%]

================================== FAILURES ===================================
_______ TestAdjustmentCheckEndpoint.test_adjustment_check_auth_required _______

self = <test_cron_adjustment.TestAdjustmentCheckEndpoint object at 0x000002F3706B1D90>

    @pytest.mark.asyncio
    async def test_adjustment_check_auth_required(self):
        """Returns 401 when no auth token provided."""
        with patch("app.core.config.settings") as mock_settings:
            mock_settings.CRON_SECRET_TOKEN = "required-token"
    
            async with AsyncClient(
                transport=ASGITransport(app=app),
                base_url="http://test"
            ) as client:
                response = await client.post("/v1/adjustment-check")
                if response.status_code != 401:
                    print(f"Auth required failed: {response.status_code}, {response.json()}")
>               assert response.status_code == 401
E               assert 500 == 401
E                +  where 500 = <Response [500 Internal Server Error]>.status_code

tests\test_cron_adjustment.py:157: AssertionError
---------------------------- Captured stdout call -----------------------------
Auth required failed: 500, {'error': {'code': '500', 'message': '{\'error\': {\'code\': \'INTERNAL_ERROR\', \'message\': "Adjustment check failed: \'coroutine\' object is not iterable"}}'}}
---------------------------- Captured stderr call -----------------------------
{"level": "WARNING", "name": "app.api.v1.cron", "message": "CRON_SECRET_TOKEN not set, skipping authentication"}
{"level": "ERROR", "name": "app.services.daily_update_service", "message": "Unexpected error in adjustment_check"}
{"level": "INFO", "name": "httpx", "message": "HTTP Request: POST http://test/v1/adjustment-check \"HTTP/1.1 500 Internal Server Error\""}
------------------------------ Captured log call ------------------------------
WARNING  app.api.v1.cron:cron.py:22 CRON_SECRET_TOKEN not set, skipping authentication
ERROR    app.services.daily_update_service:daily_update_service.py:247 Unexpected error in adjustment_check
Traceback (most recent call last):
  File "C:\Python_app\database\app\services\daily_update_service.py", line 213, in check_adjustments
    scan_result = await detector.scan_all_symbols(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python_app\database\app\services\adjustment_detector.py", line 504, in scan_all_symbols
    symbols = [row[0] for row in result.fetchall()]
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: 'coroutine' object is not iterable
INFO     httpx:_client.py:1773 HTTP Request: POST http://test/v1/adjustment-check "HTTP/1.1 500 Internal Server Error"
============================== warnings summary ===============================
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

app\schemas\fetch_jobs.py:17
  C:\Python_app\database\app\schemas\fetch_jobs.py:17: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('symbols')

app\schemas\fetch_jobs.py:34
  C:\Python_app\database\app\schemas\fetch_jobs.py:34: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_to')

app\schemas\fetch_jobs.py:53
  C:\Python_app\database\app\schemas\fetch_jobs.py:53: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_from')

app\schemas\fetch_jobs.py:64
  C:\Python_app\database\app\schemas\fetch_jobs.py:64: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('interval')

app\schemas\fetch_jobs.py:71
  C:\Python_app\database\app\schemas\fetch_jobs.py:71: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('priority')

app\schemas\fetch_jobs.py:88
  C:\Python_app\database\app\schemas\fetch_jobs.py:88: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('percent')

app\schemas\cron.py:28
  C:\Python_app\database\app\schemas\cron.py:28: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator("date_from", "date_to", pre=True)

tests/test_cron_adjustment.py::TestAdjustmentCheckEndpoint::test_adjustment_check_auth_required
  C:\Python_app\database\app\services\daily_update_service.py:200: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    start_time = datetime.utcnow()

tests/test_cron_adjustment.py::TestAdjustmentCheckEndpoint::test_adjustment_check_auth_required
  C:\Python_app\database\app\services\adjustment_detector.py:504: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    symbols = [row[0] for row in result.fetchall()]
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_cron_adjustment.py::TestAdjustmentCheckEndpoint::test_adjustment_check_auth_required
======================= 1 failed, 13 warnings in 0.23s ========================
