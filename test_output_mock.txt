============================= test session starts =============================
platform win32 -- Python 3.12.0, pytest-8.2.0, pluggy-1.6.0 -- C:\Users\simok\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Python_app\database
configfile: pyproject.toml
plugins: anyio-4.10.0, asyncio-0.23.6, cov-4.1.0, mock-3.12.0, timeout-2.4.0
asyncio: mode=Mode.AUTO
timeout: 30.0s
timeout method: thread
timeout func_only: False
collecting ... collected 1 item

tests/test_event_flow.py::test_event_driven_fix_flow FAILED              [100%]

================================== FAILURES ===================================
_________________________ test_event_driven_fix_flow __________________________

    @pytest.mark.asyncio
    async def test_event_driven_fix_flow():
        """Test that a detected split triggers a fix (using mocks)."""
    
        # Mock Session
        session = AsyncMock()
    
        # Mock list_symbols to return one symbol
        # list_symbols returns a list of Row objects or dict-like
        with patch("app.services.daily_update_service.list_symbols", new_callable=AsyncMock) as mock_list_symbols:
            mock_list_symbols.return_value = [{"symbol": "TEST_SPLIT"}]
    
            # Mock ensure_coverage to simulate the callback execution
            # We need to manually call the on_events callback passed to ensure_coverage
            async def mock_ensure_coverage(*args, **kwargs):
                on_events = kwargs.get("on_events")
                if on_events:
                    # Simulate detecting a split event
                    events = [{
                        "symbol": "TEST_SPLIT",
                        "date": date(2024, 1, 5),
                        "type": "stock_split",
                        "ratio": 2.0
                    }]
                    await on_events(events)
    
            with patch("app.services.daily_update_service.ensure_coverage", side_effect=mock_ensure_coverage) as mock_ensure_cov:
    
                # Mock event_service.record_event
                # It should return a CorporateEvent object
                mock_event = MagicMock(spec=CorporateEvent)
                mock_event.symbol = "TEST_SPLIT"
                mock_event.id = 123
                mock_event.event_type = EventTypeEnum.STOCK_SPLIT
                mock_event.status = EventStatusEnum.DETECTED
    
>               with patch("app.services.event_service.record_event", new_callable=AsyncMock) as mock_record_event:

tests\test_event_flow.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1455: in __enter__
    original, local = self.get_original()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x0000021F372D9310>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'app.services.event_service' from 'C:\\Python_app\\database\\app\\services\\event_service.py'> does not have the attribute 'record_event'

C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\unittest\mock.py:1428: AttributeError
============================== warnings summary ===============================
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\starlette\formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
..\..\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272
  C:\Users\simok\AppData\Local\Programs\Python\Python312\Lib\site-packages\pydantic\_internal\_config.py:272: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

app\schemas\fetch_jobs.py:17
  C:\Python_app\database\app\schemas\fetch_jobs.py:17: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('symbols')

app\schemas\fetch_jobs.py:34
  C:\Python_app\database\app\schemas\fetch_jobs.py:34: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_to')

app\schemas\fetch_jobs.py:53
  C:\Python_app\database\app\schemas\fetch_jobs.py:53: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('date_from')

app\schemas\fetch_jobs.py:64
  C:\Python_app\database\app\schemas\fetch_jobs.py:64: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('interval')

app\schemas\fetch_jobs.py:71
  C:\Python_app\database\app\schemas\fetch_jobs.py:71: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('priority')

app\schemas\fetch_jobs.py:88
  C:\Python_app\database\app\schemas\fetch_jobs.py:88: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator('percent')

app\schemas\cron.py:28
  C:\Python_app\database\app\schemas\cron.py:28: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.6/migration/
    @validator("date_from", "date_to", pre=True)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_event_flow.py::test_event_driven_fix_flow - AttributeError:...
======================= 1 failed, 12 warnings in 0.28s ========================
